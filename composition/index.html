<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlatziCommerce</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app">
        <header>
            <h3>PlatziCommerce</h3>
            <button class="cart" v-on:click="cartOpen = !cartOpen">Carro ({{ cart.length}})</button>
            <div class="cart-content" v-show="cartOpen">
                <div class="cart-content__product" v-for="(product, index) in cart" :key="product.name" :class="{ 'bg-gray' : index & 1 }"><!-- & 1 = impar -->
                    <img v-bind:src="product.images[0].image" :alt="product.name. toUpperCase()">
                    <span> {{ product.name }} - $ {{ new Intl.NumberFormat("es-MX").format(product.price)  }} ({{ product.quantity }})</span>
                </div>
                <p>Total: $ {{ new Intl.NumberFormat("es-MX").format(total) }}</p>
            </div>
        </header>
        <main>
            <product v-for="product in products" :key="product.name" :product="product" @sendtocart="addToCart($event)"></product>
            
        </main>
    </div> <!-- aqui se monta toda la aplicaci칩n de VUE -->
    
    <!-- Script de VUE -->
    <script src="https://unpkg.com/vue@next"></script>
    
    <!-- Logica de aplicaci칩n -->
    <script>
        const { createApp, ref, reactive, toRefs, watch } = Vue;  //crear una aplicaci칩n de vue
        const app = createApp({
            setup(){
                //Lista de productos de nuestra app
                const products = ref([
                    {
                        name: "Camara",
                        price: 450_000,
                        stock: 5,
                        content: 'Lorem ipsum dolor sit amet consectetur adipisicing elit. Ipsa tenetur, laudantium placeat obcaecati autem deleniti magni. Sit reprehenderit   ipsum quidem reiciendis suscipit, fuga pariatur molestiae deserunt ea temporibus, doloribus cumque?',
                        images: [
                            { 
                                image: "./images/camara.jpg",
                                thumbnail: "./images/camara-thumb.jpg",
                            },
                            { 
                                image: "./images/camara-2.jpg",
                                thumbnail: "./images/camara-2-thumb.jpg",
                            }
                        ],
                        new: true,
                        offer: false,
                        quantity: 1,
                    },
                    {
                        name: "Camara PL",
                        price: 250_000,
                        stock: 2,
                        content: 'Lorem ipsum dolor sit amet consectetur adipisicing elit. Ipsa tenetur, laudantium placeat obcaecati autem deleniti magni. Sit reprehenderit   ipsum quidem reiciendis suscipit, fuga pariatur molestiae deserunt ea temporibus, doloribus cumque?',
                        images: [
                            { 
                                image: "./images/camara.jpg",
                                thumbnail: "./images/camara-thumb.jpg",
                            },
                            { 
                                image: "./images/camara-2.jpg",
                                thumbnail: "./images/camara-2-thumb.jpg",
                            }
                        ],
                        new: true,
                        offer: false,
                        quantity: 1,
                    },
                    {
                        name: "Camara PL2",
                        price: 550_000,
                        stock: 3,
                        content: 'Lorem ipsum dolor sit amet consectetur adipisicing elit. Ipsa tenetur, laudantium placeat obcaecati autem deleniti magni. Sit reprehenderit   ipsum quidem reiciendis suscipit, fuga pariatur molestiae deserunt ea temporibus, doloribus cumque?',
                        images: [
                            { 
                                image: "./images/camara.jpg",
                                thumbnail: "./images/camara-thumb.jpg",
                            },
                            { 
                                image: "./images/camara-2.jpg",
                                thumbnail: "./images/camara-2-thumb.jpg",
                            }
                        ],
                        new: true,
                        offer: false,
                        quantity: 1,
                    },
                    {
                        name: "Camara PL3",
                        price: 650_000,
                        stock: 3,
                        content: 'Lorem ipsum dolor sit amet consectetur adipisicing elit. Ipsa tenetur, laudantium placeat obcaecati autem deleniti magni. Sit reprehenderit   ipsum quidem reiciendis suscipit, fuga pariatur molestiae deserunt ea temporibus, doloribus cumque?',
                        images: [
                            { 
                                image: "./images/camara.jpg",
                                thumbnail: "./images/camara-thumb.jpg",
                            },
                            { 
                                image: "./images/camara-2.jpg",
                                thumbnail: "./images/camara-2-thumb.jpg",
                            }
                        ],
                        new: true,
                        offer: false,
                        quantity: 1,
                    },
                ]); 

                const cartState = reactive({
                    cartOpen: true,
                    cart: [],
                    total: 0,

                });

                function addToCart(product){
                    const prodIndex = cartState.cart.findIndex(prod => prod.name == product.name); //validar si ya existe
                    console.log("prodIndex = " + prodIndex );
                    if(prodIndex >= 0){
                        cartState.cart[prodIndex].quantity += 1;//En el carrito Aumentar la cantidad del producto encontrado
                    }else{
                        cartState.cart.push(product); //a침adir producto al carrito
                    }
                    product.stock -= 1; //disminuir el stock    
                }

                //watcher por handler del carrito para ir sumando precio de productos
                watch(cartState.cart, (value, oldValue) => {
                    cartState.total = cartState.cart.reduce((prev, curr) => {
                        const prevPrice = prev.price || prev;
                        const prevQuantity = prev.quantity || 1;
                        return prevPrice * prevQuantity + curr.price * curr.quantity;
                    }, 0);
                }
                );

                //Las funciones setup siempre deben de retornar un objeto
                return {
                    ...toRefs(cartState),
                    products,
                    addToCart   
                    
                }
            }

        });    //insertamos en una variable app
        
    </script>

    <script src="./Product.js"></script>

    <script>
        app.mount("#app");          //montamos la constante en div 
    </script>
</body>
</html>